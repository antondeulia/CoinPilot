generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model Currency {
  code     String  @id
  type     String  // fiat | crypto
  symbol   String?
  decimals Int     @default(2)
  @@map("currencies")
}

model User {
  id                   String   @id @default(uuid())
  telegramId           String   @unique
  activeAccountId      String?
  defaultAccountId     String?
  mainCurrency         String   @default("USD")
  isPremium            Boolean  @default(false)
  premiumUntil         DateTime?
  trialUsed            Boolean  @default(false)
  stripeCustomerId     String?
  lastTipText          String?
  lastTipDate          DateTime?
  accounts             Account[]
  transactions         Transaction[]
  categories           Category[]
  tags                 Tag[]
  savedAnalyticsViews  SavedAnalyticsView[]
  alertConfigs         AlertConfig[]
  subscriptions        Subscription[]
  premiumEvents        PremiumEvent[]
  llmMemories          LlmUserMemory[]
  timezone             String   @default("UTC")
  lastDailyReminderAt  DateTime?
  createdAt            DateTime @default(now())

  @@map("users")
}

model Account {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  type      AccountTypeEnum
  currency  String
  isHidden  Boolean  @default(false)
  createdAt DateTime @default(now())

  transactions Transaction[]
  transactionsFrom Transaction[] @relation("FromAccount")
  transactionsTo Transaction[] @relation("ToAccount")
  assets     AccountAsset[]

  @@map("accounts")
}

model AccountAsset {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  currency  String
  amount    Decimal @db.Decimal(36, 18)

  @@unique([accountId, currency])
  @@map("account_assets")
}

model Transaction {
  id               String   @id @default(uuid())
  accountId        String
  account          Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  amount           Decimal @db.Decimal(36, 18)
  currency         String
  direction        TransactionDirectionsEnum
  tradeType        TradeTypeEnum? @map("trade_type")
  tradeBaseCurrency String? @map("trade_base_currency")
  tradeBaseAmount  Decimal? @map("trade_base_amount") @db.Decimal(36, 18)
  tradeQuoteCurrency String? @map("trade_quote_currency")
  tradeQuoteAmount Decimal? @map("trade_quote_amount") @db.Decimal(36, 18)
  executionPrice   Decimal? @map("execution_price") @db.Decimal(36, 18)
  tradeFeeCurrency String? @map("trade_fee_currency")
  tradeFeeAmount   Decimal? @map("trade_fee_amount") @db.Decimal(36, 18)
  categoryId       String? @map("category_id")
  categoryRef      Category? @relation("TransactionCategory", fields: [categoryId], references: [id], onDelete: SetNull)
  category         String?
  description      String?
  rawText          String
  transactionDate   DateTime @default(now())
  createdAt        DateTime @default(now())
  userId           String   @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromAccountId    String?
  fromAccount      Account? @relation(name: "FromAccount", fields: [fromAccountId], references: [id], onDelete: SetNull)
  toAccountId      String?
  toAccount        Account? @relation(name: "ToAccount", fields: [toAccountId], references: [id], onDelete: SetNull)
  tagId            String?
  tag              Tag?     @relation(fields: [tagId], references: [id], onDelete: SetNull)
  convertedAmount  Decimal? @db.Decimal(36, 18)
  convertToCurrency String?
  amountUsd        Decimal?   @map("amount_usd") @db.Decimal(36, 18)

  @@map("transactions")
}

model ExchangeRateSnapshot {
  id           String   @id @default(uuid())
  date         DateTime
  baseCurrency String   @default("USD") @map("base_currency")
  rates        Json
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([date, baseCurrency])
  @@map("exchange_rate_snapshots")
}

model Category {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  transactions Transaction[] @relation("TransactionCategory")

  @@map("categories")
}

model Tag {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  usageCount  Int      @default(0)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  aliases     TagAlias[]
  transactions Transaction[]

  @@unique([userId, name])
  @@map("tags")
}

model TagAlias {
  id        String   @id @default(uuid())
  tagId     String
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  alias     String
  createdAt DateTime @default(now())

  @@map("tag_aliases")
}

model TagAuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  details   String
  createdAt DateTime @default(now())

  @@map("tag_audit_logs")
}

model SavedAnalyticsView {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  filters   Json
  createdAt DateTime @default(now())

  @@map("saved_analytics_views")
}

model AlertConfig {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       AlertTypeEnum
  threshold  Decimal  @db.Decimal(36, 18)
  categoryId String?
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@map("alert_configs")
}

model Subscription {
  id                      String             @id @default(uuid())
  userId                  String
  user                    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                    SubscriptionPlan
  status                  SubscriptionStatus @default(active)
  startDate               DateTime           @default(now())
  endDate                 DateTime?
  telegramPaymentChargeId String?            @unique
  providerPaymentChargeId String?
  amount                  Decimal            @db.Decimal(18, 2)
  currency                String             @default("EUR")
  createdAt               DateTime           @default(now())
  autoRenew               Boolean            @default(true)

  @@map("subscriptions")
}

model PremiumEvent {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      PremiumEventType
  details   String?
  createdAt DateTime         @default(now())

  @@map("premium_events")
}

model LlmUserMemory {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // rule | correction
  key         String
  value       String
  confidence  Float    @default(1)
  hits        Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, type, key])
  @@index([userId, updatedAt])
  @@map("llm_user_memories")
}

// Enums
enum AccountTypeEnum {
  cash
  bank
  crypto
}

enum TransactionDirectionsEnum {
  income
  expense
  transfer
}

model TrialLedger {
  id             String   @id @default(uuid())
  telegramId     String   @unique @map("telegram_id")
  firstUserId    String?  @map("first_user_id")
  stripeCustomerId String? @map("stripe_customer_id")
  usedAt         DateTime @default(now()) @map("used_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("trial_ledger")
}

enum TradeTypeEnum {
  buy
  sell
}

enum AlertTypeEnum {
  large_expense
  category_threshold
}

enum SubscriptionPlan {
  monthly
  yearly
  lifetime
  trial
}

enum SubscriptionStatus {
  active
  expired
  cancelled
}

enum PremiumEventType {
  limit_hit
  premium_page_view
  upsell_shown
  feature_blocked
  trial_start
  trial_end
  purchase
  cancellation
  export_blocked
}
